<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Sanisettes proches</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([48.8566, 2.3522], 13); // Paris

    L.tileLayer("https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
    }).addTo(map);

    function onLocationFound(e) {
      const lat = e.latitude;
      const lon = e.longitude;

      L.marker([lat, lon])
        .addTo(map)
        .bindPopup("Vous êtes ici")
        .openPopup();

      fetch(`/api/nearby-sanisettes/?lat=${lat}&lon=${lon}`)
        .then((response) => response.json())
        .then((data) => {
          data.forEach((s) => {
            L.marker([s.latitude, s.longitude])
              .addTo(map)
              .bindPopup(`
                <strong>${s.adresse}</strong><br>
                Distance : ${s.distance_km} km<br>
                Accès PMR : ${s.acces_pmr}<br>
                Horaire : ${s.horaire}
              `);
          });
        })
        .catch((error) => {
          console.error("Erreur lors de la récupération des sanisettes :", error);
        });
    }

    function onLocationError(e) {
      alert("Géolocalisation échouée : " + e.message);
    }

    map.locate({ setView: true, maxZoom: 16 });
    map.on("locationfound", onLocationFound);
    map.on("locationerror", onLocationError);
  </script>
</body>
</html>
